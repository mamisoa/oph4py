[[extend "baseof.html"]]

[[ block page_head]]
<style>
    .table td {
        text-align: center;
    }

    .table th {
        text-align: center;
    }
    
    /* Form notification styles */
    .form-notification {
        border-radius: 4px;
        margin-top: 15px;
        padding: 12px 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .form-notification.alert-success {
        border-left: 4px solid #28a745;
    }
    
    .form-notification.alert-danger {
        border-left: 4px solid #dc3545;
    }
    
    .form-notification.alert-info {
        border-left: 4px solid #17a2b8;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Improve modal styling */
    .modal-content {
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    /* Improve form styling */
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    /* Loading spinner styles */
    .spinner-border {
        width: 1rem;
        height: 1rem;
        vertical-align: text-bottom;
    }
</style>
<link href="js/bootstrap-table_1.22/bootstrap-table.min.css" rel="stylesheet">
[[ end ]]

[[ block left_nav ]]
[[ include 'partials/nav-test.html' ]]
[[ end]]

<!-- bootstrap ok for table-wl -->
<div class="container-fluid" id="worklistTable"> <!-- #table-wl list -->
    <div class="row">
        <div class="col-md-12 mt-3">
            <div class="row">
                <div class="col">
                    <button type="button" id="btnFullList" class="btn btn-dark mx-2">Full list</button>
                    <button type="button" id="btnTodaysList" class="btn btn-dark mx-2">Today's list</button>
                </div>
                <div class="col form-floating">
                    <select class="form-select" id="selectProvider" class="form-control">
                        <option value="">No filter</option>"
                    </select>
                    <label for="selectProvider">Select provider</label>
                </div>
                <div class="col form-floating">
                    <select class="form-select" id="selectPractitioner" class="form-control">
                        <option value="">No filter</option>"
                    </select>
                    <label for="selectPractitioner">Select practitioner</label>
                </div>
                <div class="col">
                    <div id="toolbar-wl">
                        <h2><span><i class="fas fa-list me-2"></i>Worklist</span></h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <table id="table-wl" data-toolbar="#toolbar-wl" data-id-field="id"
                        data-side-pagination="server" data-show-refresh="true" data-pagination="true"
                        data-page-size="25" data-show-columns="true" data-search="true"
                        data-search-accent-neutralise="true" data-visible-search="false"
                        data-query-params="queryParams_wl" data-response-handler="responseHandler_wl"
                        data-row-style="rowStyle_wl" data-detail-view="true" data-detail-view-icon="true"
                        data-detail-formatter="detailFormatter_wl" data-detail-view-by-click="false">
                        <thead class="thead-dark">
                            <th data-field="id" data-sortable="true">ID</th>
                            <th data-field="sending_facility" data-sortable="true">Sending facility:</th>
                            <th data-field="receiving_facility" data-title="Receiving facility" data-sortable="true">
                                Receving facility:</th>
                            <th data-field="procedure" data-searchable="true" data-sortable="true">Procedure:</th>
                            <th data-field="patient" data-searchable="true" data-sortable="true">Patient:</th>
                            <th data-field="provider" data-searchable="true" data-sortable="true">Provider:</th>
                            <th data-field="senior" data-searchable="true" data-sortable="true">Senior:</th>
                            <th data-field="modality" data-searchable="true" data-sortable="true">Modality:</th>
                            <th data-field="laterality" data-sortable="false" data-searchable="false">Laterality:</th>
                            <th data-field="requested_time" data-sortable="true" data-searchable="true">Timeslot:</th>
                            <th data-field="status_flag" data-searchable="true" data-sortable="true">Status:</th>
                            <th data-field="counter" data-searchable="true" data-sortable="false"
                                data-formatter="counterFormatter_wl">Counter:</th>
                            <th data-field="warning" data-searchable="true" data-sortable="false">Warning:</th>
                            <th data-field="operate" data-formatter="operateFormatter_wl"
                                data-events="operateEvents_wl">Action</th>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div> <!-- end row -->
</div> <!-- end container fluid -->

<!-- bootstrap ok for auth_user table -->
<div class="container-fluid" id="userTable"> <!-- #table list -->
    <div class="row">
        <div class="col-md-12 mt-3">
            <div>
                <h2><span class=""><i class="fas [[=class_icon]]"></i> [[=group]]s<span></h2>
                <div id="toolbar">
                    <button type="button" id="btnNewUser" class="btn btn-dark" data-bs-toggle="modal"
                        data-bs-target="#newUserModal">
                        New [[=group]]
                    </button>
                    <button type="button" id="btnCheckUser" class="btn btn-secondary">
                        Check existing user
                    </button>
                </div>
            </div>
            <table id="table" data-toolbar="#toolbar" data-id-field="id" data-toggle="table"
                data-side-pagination="server" data-show-refresh="true" data-pagination="true" data-page-size="10"
                data-show-columns="true" data-search="true" data-search-accent-neutralise="true"
                data-visible-search="false" data-data-field="items" data-query-params="queryParams"
                data-total-field="count">
                <thead class="thead-dark">
                    <th data-field="last_name" data-sortable="true">Last name:</th>
                    <th data-field="first_name" data-title="First name" data-sortable="true">First name:</th>
                    <th data-field="gender.sex" data-searchable="true" data-sortable="true">Gender:</th>
                    <th data-field="dob" data-sortable="true">Date of birth:</th>
                    <th data-field="age" data-formatter="ageFormatter" data-sortable="false">Age:</th>
                    <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents">Action</th>
                </thead>
            </table>
        </div>
    </div> <!-- end row -->
</div> <!-- end container fluid -->


<!-- Modal newUserModal -->
<div class="modal fade" id="newUserModal" tabindex="-1" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New user</h5>
                <button id="btnGetUserId" type="button" class="btn btn-outline-dark btn-sm m-3"><i
                        class="fas fa-id-card"></i></button>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <form id="userForm" enctype="multipart/form-data" method="POST">
                                <div class="row mb-3">
                                    <div class="col photoDiv visually-hidden">
                                        <img id="photoidc" class="photoId" src="" alt="Photo from EID">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="firstName" class="form-label">First name:</label>
                                        <input id="firstName" type="text" class="form-control" name="first_name"
                                            autocomplete="off">
                                        <div id="firstNameHelp" class="form-text">Enter your first name</div>
                                    </div>
                                    <div class="col">
                                        <label for="lastName" class="form-label">Last name:</label>
                                        <input id="lastName" type="text" class="form-control" name="last_name">
                                        <div id="lastNameHelp" class="form-text">Enter your last name</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="username" class="form-label">Username:</label>
                                        <input id="username" type="text" class="form-control"
                                            title="Username must not be blank and contain only letters, numbers and underscores."
                                            name="username" required pattern="\w+" autocomplete="off" />
                                        <div id="usernameHelp" class="form-text">Enter your username</div>
                                    </div>
                                    <div class="col">
                                        <label for="email" class="form-label">Email:</label>
                                        <input id="email" type="email" class="form-control" name="email"
                                            autocomplete="off">
                                        <div id="emailHelp" class="form-text">Enter your email</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="newUserdob" class="form-label">dob:</label>
                                        <input id="newUserdob" type="date" class="form-control" name="dob" required>
                                        <div id="dobHelp" class="form-text">Enter your dob</div>
                                    </div>
                                    <div class="col-2">
                                        <label for="phone_prefix" class="form-label">Prefix:</label>
                                        <div class="input-group">
                                            <span class="input-group-text">+</span>
                                            <input id="phone_prefix" type="text" class="form-control"
                                                name="phone_prefix">
                                        </div>
                                        <div id="prefixHelp" class="form-text">Enter country's prefix</div>
                                    </div>
                                    <div class="col">
                                        <label for="phone" class="form-label">Mobile:</label>
                                        <input id="phone" type="text" class="form-control" name="phone"
                                            autocomplete="off">
                                        <div id="phoneHelp" class="form-text">Enter mobile phone</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="password" class="form-label">Password:</label>
                                        <input id="password" type="password" class="form-control"
                                            autocomplete="new-password"
                                            title="Password must contain at least 6 characters, including UPPER/lowercase and numbers."
                                            name="password" required>
                                        <div id="passwordHelp" class="form-text">Enter your password</div>
                                    </div>
                                    <div class="col">
                                        <label for="passwordCheck" class="form-label">Password check:</label>
                                        <input id="passwordCheck" type="password" class="form-control"
                                            title="Please enter the same Password" name="passwordCheck">
                                        <div id="passwordCheckHelp" class="form-text">Retype your password</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="membershipSelect" class="form-label">Role:</label>
                                        <select id="membershipSelect" class="form-select" name="membership">
                                            [[ =roleOptions ]]
                                        </select>
                                        <div id="membershipHelp" class="form-text">Choose your role</div>
                                    </div>
                                    <div class="col">
                                        <label for="genderSelect" class="form-label">Gender:</label>
                                        <select id="genderSelect" class="form-select" name="gender">
                                            [[ =genderOptions ]]
                                        </select>
                                        <div id="membershipHelp" class="form-text">Choose gender</div>
                                    </div>
                                </div>
                                <input id="newUserNationality" type="text" class="visually-hidden" name="nationality" />
                                <input id="newUserbirthTown" type="text" class="visually-hidden" name="birth_town" />
                                <input id="newUserbirthCountry" type="text" class="visually-hidden"
                                    name="birth_country" />
                                <input id="newUserIdcNum" type="text" class="visually-hidden" name="idc_num" />
                                <input id="newUserSsn" type="text" class="visually-hidden" name="ssn" />
                                <input id="newUserPhoto" type="text" class="visually-hidden" name="photob64" />
                                <input id="newUserAddress" type="text" class="visually-hidden" name="address"
                                    autocomplete="off" />
                                <input id="newUserZip" type="text" class="visually-hidden" name="zipcode" />
                                <input id="newUserTown" type="text" class="visually-hidden" name="town" />
                                <input id="btnNewUserSubmit" type="submit" class="visually-hidden" />
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnSubmitUser" class="btn btn-primary" onclick="submitUserForm()">Submit</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal newWlItemModal -->
<div class="modal fade" id="newWlItemModal" tabindex="-1" role="dialog" aria-labelledby="modalWlTitleId"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New worklist item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row mb-2" style="border: solid blue;">
                        <div class="col">
                            <form id="newWlItemForm" enctype="multipart/form-data" method="POST">
                                <div class="container">
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="sendingFacilitySelect" class="form-label">From:</label>
                                            <select id="sendingFacilitySelect" class="form-select"
                                                name="sending_facility">
                                                [[ =sendingFacilityOptions ]]
                                            </select>
                                            <div id="sendingFacilityHelp" class="form-text">Sending facility</div>
                                        </div>
                                        <div class="col">
                                            <label for="receivingFacilitySelect" class="form-label">To:</label>
                                            <select id="receivingFacilitySelect" class="form-select"
                                                name="receiving_facility">
                                                [[ =receivingFacilityOptions ]]
                                            </select>
                                            <div id="receivingFacilityHelp" class="form-text">Receiving facility</div>
                                        </div>
                                        <div class="col">
                                            <label for="procedureSelect" class="form-label">Procedure:</label>
                                            <select id="procedureSelect" class="form-select" name="procedure">
                                                [[ =procedureOptions ]]
                                            </select>
                                            <div id="procedureHelp" class="form-text">Choose procedure</div>
                                        </div>
                                        <div class="col">
                                            <label for="providerSelect" class="form-label">Provider:</label>
                                            <select id="providerSelect" class="form-select" name="provider">
                                                [[ =providerOptions ]]
                                            </select>
                                            <div id="providerHelp" class="form-text">Choose provider</div>
                                        </div>
                                        <div class="col">
                                            <label for="seniorSelect" class="form-label">Senior:</label>
                                            <select id="seniorSelect" class="form-select" name="senior">
                                                [[ =seniorOptions ]]
                                            </select>
                                            <div id="seniorHelp" class="form-text">Choose senior</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="requested_time" class="form-label">Timeslot:</label>
                                            <input id="requested_time" type="datetime-local" step="1"
                                                class="form-control" name="requested_time">
                                            <div id="requestTimeHelp" class="form-text">Choose timeslot</div>
                                        </div>
                                        <div class="col" id="modality_destDiv">
                                            <label for="modality_destSelect" class="form-label">Modality:</label>
                                            <select id="modality_destSelect" class="form-select" name="modality_dest">
                                            </select>
                                            <div id="modality_destHelp" class="form-text">Choose modality</div>
                                        </div>
                                        <div class="col visually-hidden" id="modality_destPutDiv">
                                            <label for="modality_destSelectPut" class="form-label">Modality:</label>
                                            <select id="modality_destSelectPut" class="form-select"
                                                name="modality_destPut">
                                                [[ =everyModalityOptions]]
                                            </select>
                                            <div id="modality_destHelpPUT" class="form-text">Choose modality</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label class="form-label">Side:
                                                <div class="input-group" id="lateralityGroup">
                                                    <div class="btn-group laterality">
                                                        <input type="radio" id="laterality_both" name="laterality"
                                                            class="btn-check" value="both" autocomplete="off">
                                                        <label class="btn btn-outline-primary"
                                                            for="laterality_both">Both</label>
                                                        <input type="radio" id="laterality_left" name="laterality"
                                                            class="btn-check" value="left" autocomplete="off">
                                                        <label class="btn btn-outline-primary"
                                                            for="laterality_left">Left</label>
                                                        <input type="radio" id="laterality_right" name="laterality"
                                                            class="btn-check" value="right" autocomplete="off">
                                                        <label class="btn btn-outline-primary"
                                                            for="laterality_right">Right</label>
                                                        <input type="radio" id="laterality_none" name="laterality"
                                                            class="btn-check" value="none" autocomplete="off">
                                                        <label class="btn btn-outline-primary"
                                                            for="laterality_none">None</label>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="col">
                                            <label class="form-label">Status:
                                                <div class="btn-group statusFlag" id="statusFlagGroup">
                                                    <input type="radio" id="status_requested" name="status_flag"
                                                        class="btn-check" value="requested" autocomplete="off">
                                                    <label class="btn btn-outline-primary"
                                                        for="status_requested">Request</label>
                                                    <input type="radio" id="status_processing" name="status_flag"
                                                        class="btn-check" value="processing" autocomplete="off">
                                                    <label class="btn btn-outline-warning"
                                                        for="status_processing">Process</label>
                                                    <input type="radio" id="status_done" name="status_flag"
                                                        class="btn-check" value="done" autocomplete="off">
                                                    <label class="btn btn-outline-success"
                                                        for="status_done">Done</label>
                                                    <input type="radio" id="status_cancelled" name="status_flag"
                                                        class="btn-check" value="cancelled" autocomplete="off">
                                                    <label class="btn btn-outline-secondary"
                                                        for="status_cancelled">Cancel</label>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="col">
                                            <label class="form-label">Counter:
                                                <div class="input-group mb-3" id="counterGroup">
                                                    <button class="btn btn-outline-secondary counter_down"
                                                        type="button">-</button>
                                                    <input type="text" class="form-control counter text-center"
                                                        value="1" aria-label="Counter" name="counter">
                                                    <button class="btn btn-outline-secondary counter_up"
                                                        type="button">+</button>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="warning" class="form-label">Warning:</label>
                                            <input id="warning" type="text" class="form-control" name="warning">
                                            <div id="warningHelp" class="form-text">Signal any warning message</div>
                                        </div>
                                    </div>
                                    <div id="wlItemAddDiv" class="row mb-3">
                                        <div class="col">
                                            <button id="btnWlItemAdd" class="btn btn-primary" type="button">Add item to
                                                worklist <i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <input id="idPatientWl" type="text" class="visually-hidden" name="id_auth_user" />
                                    <input id="idWl" type="text" class="visually-hidden" name="id" />
                                    <input id="methodWlItemSubmit" type="text" class="visually-hidden"
                                        name="methodWlItemSubmit" value="POST" />
                                    <input id="btnNewWlItemSubmit" type="submit" class="visually-hidden" />
                                </div> <!--end container form  -->
                            </form>
                        </div> <!--end col row  -->
                    </div> <!--end div row  -->
                    <div class="row" id="wlItemsDiv" style="border: solid red;">
                        <div class="col">
                            <ol class="list-group" id="wlItemsOl">
                                <li class="list-group-item">
                                    <table class="table">
                                        <thead id="theadItems">
                                        </thead>
                                        <tbody id="tbodyItems">
                                        </tbody>
                                    </table>
                                </li>
                            </ol>
                        </div>
                    </div> <!--end div row  -->
                </div> <!--end div container -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnSubmitWlItem" class="btn btn-primary" onclick="submitWlItemForm()">Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="visually-hidden container">
    testing
</div>

[[ block js_scripts]]
<script src="js/bootstrap-table_1.22/bootstrap-table.min.js"></script>
<script src="js/bootbox/bootbox.all.min.js"></script>
<script src="js/jquery.serialize-object.min.js"></script>
<script src="js/timer.jquery.min.js"></script>
<script src="js/useful.js"></script>
<script type="text/javascript">
    // Initialize global variables
    window.modalityDict = [[=XML(modalityDict)]];
    window.multiplemod = [[=multiplemod]];
    window.practitionerDict = [[=XML(practitionerDict)]];
    window.providerDict = [[=XML(providerDict)]];
    window.membership = [[=membership]];
    window.HOSTURL = "[[=hosturl]]";
    window.LOCAL_BEID = "[[=localbeid]]";
    window.timer_id = [];
    window.timeOffset = 0;
    window.TODAY_DATE = new Date().addHours(timeOffsetInHours).toJSON().slice(0, 10);
    window.API_USER_LIST = window.HOSTURL + "[[=URL('api','auth_user')]]" + "?@lookup=gender:gender[id,sex]&@order=~id&@count=true";
    window.API_PROCEDURE_LIST = window.HOSTURL + "[[=URL('api','worklist')]]" + "?@count=true&@lookup=id_auth_user!:id_auth_user[id,first_name,last_name],provider!:provider[id,first_name,last_name],procedure!:procedure,modality!:modality_dest[id,modality_name],receiving_facility!:receiving_facility[id,facility_name],sending_facility!:sending_facility[id,facility_name],senior!:senior[id,first_name,last_name],created_by!:created_by[id,first_name,last_name],modified_by!:modified_by[id,first_name,last_name]&@order=~requested_time,~id";
    window.API_PROCEDURE_LIST_TODAY = window.HOSTURL + "[[=URL('api','worklist')]]" + "?@count=true&created_on.gt=" + window.TODAY_DATE + "&@lookup=id_auth_user!:id_auth_user[id,first_name,last_name],provider!:provider[id,first_name,last_name],procedure!:procedure,modality!:modality_dest[id,modality_name],receiving_facility!:receiving_facility[id,facility_name],sending_facility!:sending_facility[id,facility_name],senior!:senior[id,first_name,last_name],created_by!:created_by[id,first_name,last_name],modified_by!:modified_by[id,first_name,last_name]&@order=~requested_time,~id";
    
    // Add direct submit handler for the original form submission
    $(document).ready(function() {
        // Store table reference globally for event handlers
        window.$table_wl = $('#table-wl');
        window.$table = $('#table');
    });
</script>
<script type="module">
    // Import and initialize modules
    import { init as initWlBt } from "./js/wl_bt.js";
    import { init as initUsersBt } from "./js/users_bt.js";
    
    // Initialize modules and tables in sequence
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            console.log("Initializing modules...");
            
            // Wait for global variables to be set
            if (!window.modalityDict || !window.providerDict || !window.practitionerDict) {
                throw new Error("Required global variables not initialized");
            }
            
            // Initialize modules first
            await Promise.all([
                initWlBt(),
                initUsersBt()
            ]);
            
            console.log("Modules initialized successfully");
            
            // Verify that required functions are exposed
            const requiredFunctions = [
                'queryParams_wl',
                'responseHandler_wl',
                'operateFormatter_wl',
                'operateEvents_wl',
                'rowStyle_wl',
                'detailFormatter_wl',
                'counterFormatter_wl',
                'rowAttributes_wl',
                'cellStyle_timeslot',
                'set_timers',
                'getFilterStatus'
            ];

            // Check each function individually with detailed logging
            for (const funcName of requiredFunctions) {
                const funcType = typeof window[funcName];
                console.log(`Checking ${funcName}: ${funcType}`);
                
                if (funcType !== 'function' && funcType !== 'object') {
                    throw new Error(`Missing or invalid function: ${funcName} (type: ${funcType})`);
                }
            }
            
            // Initialize users table
            const $table = $('#table').bootstrapTable({
                url: window.API_USER_LIST,
                formatSearch: function () {
                    return 'Last name,first name, gender';
                }
            });

            // Initialize worklist table
            const $table_wl = $('#table-wl').bootstrapTable({
                url: window.API_PROCEDURE_LIST_TODAY,
                formatSearch: function () {
                    return 'Last name,first name,procedure,modality';
                }
            });

            // Store table reference globally for event handlers
            window.$table_wl = $table_wl;

            // Hide columns in wl table
            $table_wl.bootstrapTable('hideColumn', 'id');
            $table_wl.bootstrapTable('hideColumn', 'sending_facility');
            $table_wl.bootstrapTable('hideColumn', 'receiving_facility');

            // Set up post-body event handler
            $('#table-wl').on('post-body.bs.table', function () {
                if (typeof window.set_timers === 'function' && Array.isArray(window.timer_id)) {
                    window.set_timers(window.timer_id);
                }
                
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            });

            // Auto refresh table
            var timeoutID = window.setInterval(function () {
                $('#table-wl').bootstrapTable('refresh');
            }, 40000);

            // Refresh on back/forward navigation
            if (window.performance.getEntriesByType('navigation')[0].type === 'back_forward') {
                $('#table-wl').bootstrapTable('refresh');
            }
            
            console.log("Tables initialized successfully");
        } catch (error) {
            console.error("Error during initialization:", error);
        }
    });
</script>
<script type="text/javascript">
    // Simple form submission function that bypasses all the complex handlers
    function submitUserForm() {
        console.log('User form submission started');
        
        // Get form data
        const form = document.getElementById('userForm');
        if (!form) {
            showNotification('error', 'Form not found');
            return;
        }
        
        // Show loading indicator
        showNotification('loading', 'Processing request...');
        
        // Collect form data
        const formData = new FormData(form);
        const formObj = {};
        
        // Convert FormData to object, only including non-empty values
        for (const [key, value] of formData.entries()) {
            if (value !== null && value !== undefined && value.toString().trim() !== '') {
                formObj[key] = value;
            }
        }
        
        // Log raw form data before processing
        console.log('Raw form data:', formObj);
        
        // Remove password check
        delete formObj.passwordCheck;
        
        // Basic capitalization
        if (formObj.first_name) {
            formObj.first_name = formObj.first_name.charAt(0).toUpperCase() + formObj.first_name.slice(1).toLowerCase();
        }
        if (formObj.last_name) {
            formObj.last_name = formObj.last_name.charAt(0).toUpperCase() + formObj.last_name.slice(1).toLowerCase();
        }
        
        // Check required fields
        const requiredFields = ['first_name', 'last_name', 'username', 'password', 'dob', 'gender', 'membership'];
        const missingFields = requiredFields.filter(field => !formObj[field]);
        
        if (missingFields.length > 0) {
            console.error('Missing required fields:', missingFields);
            showNotification('error', 'Missing required fields: ' + missingFields.join(', '));
            return;
        }
        
        // Log final data to be submitted
        console.log('Final form data to submit:', formObj);
        
        // Convert to JSON string
        const jsonData = JSON.stringify(formObj);
        
        // Get app name
        const pathParts = window.location.pathname.split('/');
        const app_name = pathParts.length > 1 ? pathParts[1] : 'oph4py';
        
        // Build API URL
        const apiUrl = window.location.origin + '/' + app_name + '/api/auth_user';
        console.log('API endpoint URL:', apiUrl);
        console.log('Request payload (JSON):', jsonData);
        
        // Perform fetch
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: jsonData
        })
        .then(response => {
            // Log the raw response
            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers].reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {}));
            
            // Get the response text first to properly debug any errors
            return response.text().then(text => {
                console.log('Raw response text:', text);
                const data = text.length ? JSON.parse(text) : {};
                console.log('Parsed response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || `Server returned ${response.status}`);
                }
                return data;
            });
        })
        .then(data => {
            // Show success message
            console.log('Form submission successful, response data:', data);
            showNotification('success', 'User created successfully!');
            
            // Reset form
            form.reset();
            
            // Close modal after delay
            setTimeout(() => {
                $('#newUserModal').modal('hide');
                
                // Refresh table if available
                if (typeof $table !== 'undefined' && $table && $table.bootstrapTable) {
                    $table.bootstrapTable('refresh');
                }
            }, 1500);
        })
        .catch(error => {
            // Show error message
            console.error('Form submission failed:', error);
            showNotification('error', error.message);
        });
    }
    
    function submitWlItemForm() {
        console.log('Worklist item form submission started');
        
        // Get form data
        const form = document.getElementById('newWlItemForm');
        if (!form) {
            showNotification('error', 'Form not found', 'newWlItemForm');
            return;
        }
        
        // Show loading indicator
        showNotification('loading', 'Processing request...', 'newWlItemForm');
        
        // Collect form data
        const formData = new FormData(form);
        const formObj = {};
        
        // Convert FormData to object, only including non-empty values
        for (const [key, value] of formData.entries()) {
            if (value !== null && value !== undefined && value.toString().trim() !== '') {
                formObj[key] = value;
            }
        }
        
        // Log raw form data before processing
        console.log('Raw worklist form data:', formObj);
        
        // Check required fields
        const requiredFields = ['sending_facility', 'receiving_facility', 'procedure', 'provider', 'senior', 'requested_time', 'modality_dest', 'status_flag'];
        const missingFields = requiredFields.filter(field => !formObj[field]);
        
        if (missingFields.length > 0) {
            console.error('Missing required fields for worklist item:', missingFields);
            showNotification('error', 'Missing required fields: ' + missingFields.join(', '), 'newWlItemForm');
            return;
        }
        
        // Set default laterality if not specified
        if (!formObj.laterality) {
            formObj.laterality = 'none';
            console.log('Setting default laterality: none');
        }
        
        // Log final data to be submitted
        console.log('Final worklist data to submit:', formObj);
        
        // Convert to JSON string
        const jsonData = JSON.stringify(formObj);
        
        // Get app name
        const pathParts = window.location.pathname.split('/');
        const app_name = pathParts.length > 1 ? pathParts[1] : 'oph4py';
        
        // Build API URL
        const apiUrl = window.location.origin + '/' + app_name + '/api/worklist';
        console.log('API endpoint URL for worklist:', apiUrl);
        console.log('Worklist request payload (JSON):', jsonData);
        
        // Perform fetch
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: jsonData
        })
        .then(response => {
            // Log the raw response
            console.log('Worklist response status:', response.status);
            console.log('Worklist response headers:', [...response.headers].reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {}));
            
            // Get the response text first to properly debug any errors
            return response.text().then(text => {
                console.log('Raw worklist response text:', text);
                const data = text.length ? JSON.parse(text) : {};
                console.log('Parsed worklist response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || `Server returned ${response.status}`);
                }
                return data;
            });
        })
        .then(data => {
            // Show success message
            console.log('Worklist form submission successful, response data:', data);
            showNotification('success', 'Worklist item created successfully!', 'newWlItemForm');
            
            // Reset form
            form.reset();
            
            // Close modal after delay
            setTimeout(() => {
                $('#newWlItemModal').modal('hide');
                
                // Refresh table if available
                if (typeof $table_wl !== 'undefined' && $table_wl && $table_wl.bootstrapTable) {
                    $table_wl.bootstrapTable('refresh');
                }
            }, 1500);
        })
        .catch(error => {
            // Show error message
            console.error('Worklist form submission failed:', error);
            showNotification('error', error.message, 'newWlItemForm');
        });
    }
    
    // Function to show notifications
    function showNotification(type, message, formId = 'userForm') {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.form-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'form-notification alert mt-3';
        
        // Set appropriate classes and content based on type
        switch(type) {
            case 'success':
                notification.className += ' alert-success';
                notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
                break;
            case 'error':
                notification.className += ' alert-danger';
                notification.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
                break;
            case 'loading':
                notification.className += ' alert-info';
                notification.innerHTML = `<div class="spinner-border spinner-border-sm me-2" role="status"></div>${message}`;
                break;
            default:
                notification.className += ' alert-info';
                notification.textContent = message;
        }
        
        // Get the target form
        const form = document.getElementById(formId);
        if (!form) {
            // If form not found, try the alternative
            const alternativeFormId = formId === 'userForm' ? 'newWlItemForm' : 'userForm';
            const alternativeForm = document.getElementById(alternativeFormId);
            
            if (alternativeForm) {
                alternativeForm.parentNode.appendChild(notification);
            } else {
                // If neither form is found, append to body
                document.body.appendChild(notification);
            }
        } else {
            // Append to form's parent
            form.parentNode.appendChild(notification);
        }
        
        // Auto-remove success and error notifications after 5 seconds
        if (type !== 'loading') {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        return notification;
    }
    
    // Make functions globally available
    window.submitUserForm = submitUserForm;
    window.submitWlItemForm = submitWlItemForm;
    window.showNotification = showNotification;
</script>
[[ end ]]