[[extend "baseof.html"]]

[[ block page_head]]
<link href="js/bootstrap-table_1.22/bootstrap-table.min.css" rel="stylesheet">
<style>
    /* overide when topnavbar is not fixed-top */
    section#main {
        margin-top: 0px;
    }
</style>
[[ end ]]

[[ block left_nav ]]
[[ end]]

[[ include 'partials/patient-bar.html' ]]

<div class="container-fluid mt-2">
    <div class="row g-0 text-center" style="background-color: #f8f5f0;">
        <div class="col">
            <h1>AIR TONOMETRY</h1>
        </div>
    </div>
    <div class="row mt-3 text-center">
        <div class="col">
            <div class="col" style="background-color: #D5E3EE;">
                <h2>RIGHT EYE</h2>
            </div>
        </div>
        <div class="col">
            <div class="col" style="background-color: #EED9D5;">
                <h2>LEFT EYE</h2>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col">
            <div class="row mb-3">
                <div class="col">
                    <form action="" class="row" id="airRightForm">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col">
                                    <label for="airRight" class="form-label">Air tonometry (RE):</label>
                                    <div class="input-group mb-3">
                                        <button class="btn btn-outline-secondary counter_down_tono"
                                            type="button">-</button>
                                        <input type="text" class="form-control airRight counter_tono text-center"
                                            value="15.00" aria-label="Air tonometry" name="airRight" id="airRight">
                                        <button class="btn btn-outline-secondary counter_up_tono"
                                            type="button">+</button>
                                    </div>
                                </div>
                                <div class="col">
                                    <label for="pachyRight" class="form-label">Pachymetry (RE):</label>
                                    <div class="input-group mb-3">
                                        <button class="btn btn-outline-secondary counter_down_pachy"
                                            type="button">-</button>
                                        <input type="text" class="form-control pachyRight counter_pachy text-center"
                                            value="550" aria-label="Optical pachymetry" name="pachyRight"
                                            id="pachyRight">
                                        <button class="btn btn-outline-secondary counter_up_pachy"
                                            type="button">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3" id="tonoPachyRight">
                                <div class="col">
                                    <button id="btnAddTonoPachyRight" class="btn btn-primary" type="submit">Submit right
                                        TonoPachy<i class=" mx-2 fas fa-plus"></i></button>
                                </div>
                            </div>
                            <input id="idPatientWl" type="text" class="visually-hidden" name="id_auth_user" />
                        </div>
                    </form>
                </div> <!-- end airRight col -->
                <div class="col">
                    <form action="" id="airLeftForm">
                        <div class="row">
                            <div class="col">
                                <label for="airLeft" class="form-label">Air tonometry (LE):</label>
                                <div class="input-group mb-3">
                                    <button class="btn btn-outline-secondary counter_down_tono" type="button">-</button>
                                    <input type="text" class="form-control airLeft text-center counter_tono" value="15"
                                        aria-label="Air tonometry" name="airLeft" id="airLeft">
                                    <button class="btn btn-outline-secondary counter_up_tono" type="button">+</button>
                                </div>
                            </div>
                            <div class="col">
                                <label for="pachyLeft" class="form-label">Pachymetry (LE):</label>
                                <div class="input-group mb-3">
                                    <button class="btn btn-outline-secondary counter_down_pachy"
                                        type="button">-</button>
                                    <input type="text" class="form-control pachyLeft counter_pachy text-center"
                                        value="550" aria-label="Optical pachymetry" name="pachyLeft" id="pachyLeft">
                                    <button class="btn btn-outline-secondary counter_up_pachy" type="button">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3" id="tonoPachyLeft">
                            <div class="col">
                                <button id="btnAddTonoPachyLeft" class="btn btn-primary" type="submit">Submit left
                                    TonoPachy<i class=" mx-2 fas fa-plus"></i></button>
                            </div>
                            <input id="idPatientWl" type="text" class="visually-hidden" name="id_auth_user" />
                        </div>
                    </form>
                </div> <!-- end airLeft col -->
            </div> <!-- end row airPachy form col -->
            <div class="row mb-3">
                <div class="col">
                    <table id="airPachyRight_tbl" data-side-pagination="server" data-pagination="true"
                        data-page-size="10" data-search="false" data-query-params="queryParams_airPachy"
                        data-response-handler="responseHandler_airPachy">
                        <thead>
                            <tr>
                                <th data-field="timestamp" data-sortable="false">Timestamp</th>
                                <th data-field="tonometry" data-sortable="false">Tono(air)</th>
                                <th data-field="pachymetry" data-sortable="false">Pachy</th>
                                <th data-field="operate" data-formatter="operateFormatter_airPachy"
                                    data-events="operateEvents_airPachy">Action</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="col">
                    <table id="airPachyLeft_tbl" data-side-pagination="server" data-pagination="true"
                        data-page-size="10" data-query-params="queryParams_airPachy"
                        data-response-handler="responseHandler_airPachy">
                        <thead>
                            <tr>
                                <th data-field="timestamp" data-sortable="false">Timestamp</th>
                                <th data-field="tonometry" data-sortable="true">Tono(air)</th>
                                <th data-field="pachymetry" data-sortable="true">Pachy</th>
                                <th data-field="operate" data-formatter="operateFormatter_airPachy"
                                    data-events="operateEvents_airPachy">Action</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-2">
    <div class="row g-0 text-center big-title">
        <div class="col">
            <h1>APLANATION TONOMETRY</h1>
        </div>
    </div>
    <div class="row mt-3 text-center">
        <div class="col">
            <div class="col title-right">
                <h2>RIGHT EYE</h2>
            </div>
        </div>
        <div class="col">
            <div class="col title-left">
                <h2>LEFT EYE</h2>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col">
            <div class="row mb-3">
                <div class="col">
                    <form action="" class="row bg-right" id="aplaRightForm">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col">
                                    <label for="aplaRight" class="form-label">Aplanation tonometry (RE):</label>
                                    <div class="input-group mb-3">
                                        <button class="btn btn-outline-secondary counter_down_tono"
                                            type="button">-</button>
                                        <input type="text" class="form-control aplaRight counter_tono text-center"
                                            value="15.00" aria-label="Air tonometry" name="aplaRight" id="aplaRight">
                                        <button class="btn btn-outline-secondary counter_up_tono"
                                            type="button">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3" id="AplaRight">
                                <div class="col">
                                    <button id="btnAddAplaRight" class="btn btn-primary" type="submit">Submit right
                                        aplanation<i class=" mx-2 fas fa-plus"></i></button>
                                </div>
                            </div>
                            <input id="idPatientWl" type="text" class="visually-hidden" name="id_auth_user" />
                        </div>
                    </form>
                </div> <!-- end aplaRight col -->
                <div class="col">
                    <form action="" class="bg-left" id="aplaLeftForm">
                        <div class="row">
                            <div class="col">
                                <label for="aplaLeft" class="form-label">Aplanation tonometry (LE):</label>
                                <div class="input-group mb-3">
                                    <button class="btn btn-outline-secondary counter_down_tono" type="button">-</button>
                                    <input type="text" class="form-control aplaLeft text-center counter_tono" value="15"
                                        aria-label="Air tonometry" name="aplaLeft" id="aplaLeft">
                                    <button class="btn btn-outline-secondary counter_up_tono" type="button">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3" id="aplaLeft">
                            <div class="col">
                                <button id="btnAddAplaLeft" class="btn btn-primary" type="submit">Submit left
                                    TonoPachy<i class=" mx-2 fas fa-plus"></i></button>
                            </div>
                            <input id="idPatientWl" type="text" class="visually-hidden" name="id_auth_user" />
                        </div>
                    </form>
                </div> <!-- end aplaLeft col -->
            </div> <!-- end row apla form col -->
            <div class="row mb-3">
                <div class="col">
                    <table id="aplaRight_tbl" data-side-pagination="server" data-pagination="true" data-page-size="10"
                        data-search="false" data-query-params="queryParams_airPachy"
                        data-response-handler="responseHandler_airPachy">
                        <thead>
                            <tr>
                                <th data-field="timestamp" data-sortable="false">Timestamp</th>
                                <th data-field="tonometry" data-sortable="false">Tono(apla)</th>
                                <th data-field="operate" data-formatter="operateFormatter_airPachy"
                                    data-events="operateEvents_airPachy">Action</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="col">
                    <table id="aplaLeft_tbl" data-side-pagination="server" data-pagination="true" data-page-size="10"
                        data-query-params="queryParams_airPachy" data-response-handler="responseHandler_airPachy">
                        <thead>
                            <tr>
                                <th data-field="timestamp" data-sortable="false">Timestamp</th>
                                <th data-field="tonometry" data-sortable="true">Tono(apla)</th>
                                <th data-field="operate" data-formatter="operateFormatter_airPachy"
                                    data-events="operateEvents_airPachy">Action</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal tonoPachyModal -->
<div class="modal fade" id="tonoPachyModal" tabindex="-1" role="dialog" aria-labelledby="modalTitleId"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit tono/pachy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <form id="tonoPachyForm" enctype="multipart/form-data" method="POST">
                                <div class="row mb-3">
                                    <div class="col">
                                        <span class="form-label">Side:</span>
                                        <div class="input-group">
                                            <div class="btn-group laterality">
                                                <input type="radio" id="laterality_right" name="laterality"
                                                    class="btn-check" value="right" autocomplete="off">
                                                <label class="btn btn-outline-primary"
                                                    for="laterality_right">Right</label>
                                                <input type="radio" id="laterality_left" name="laterality"
                                                    class="btn-check" value="left" autocomplete="off">
                                                <label class="btn btn-outline-primary"
                                                    for="laterality_left">Left</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col" id="technoDiv">
                                        <span class="form-label">Method:</span>
                                        <div class="input-group">
                                            <div class="btn-group techno">
                                                <input type="radio" id="techno_air" name="techno" class="btn-check"
                                                    value="air" autocomplete="off">
                                                <label class="btn btn-outline-primary" for="techno_air">Air</label>
                                                <input type="radio" id="techno_apla" name="techno" class="btn-check"
                                                    value="apla" autocomplete="off">
                                                <label class="btn btn-outline-primary" for="techno_apla">Apla</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="tono_modal" class="form-label">Tonometry:</label>
                                        <div class="input-group mb-3">
                                            <button class="btn btn-outline-secondary counter_down_tono"
                                                type="button">-</button>
                                            <input type="text" class="form-control tono counter_tono text-center"
                                                value="15.00" aria-label="Air tonometry" name="tonometry"
                                                id="tono_modal">
                                            <button class="btn btn-outline-secondary counter_up_tono"
                                                type="button">+</button>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div id="pachyDiv">
                                            <label for="pachy_modal" class="form-label">Pachymetry:</label>
                                            <div class="input-group mb-3">
                                                <button class="btn btn-outline-secondary counter_down_pachy"
                                                    type="button">-</button>
                                                <input type="text" class="form-control pachy counter_pachy text-center"
                                                    value="550" aria-label="Optical pachymetry" name="pachymetry"
                                                    id="pachy_modal">
                                                <button class="btn btn-outline-secondary counter_up_pachy"
                                                    type="button">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="timestamp" class="form-label">Timestamp:</label>
                                        <input id="timestamp" type="datetime-local" step="1" class="form-control"
                                            name="timestamp">
                                        <div id="requestTimeHelp" class="form-text">Adjust timestamp</div>
                                    </div>
                                </div>
                                <input id="idTonoPachy" type="text" class="visually-hidden" name="id" />
                                <input id="idPatient" type="text" class="visually-hidden" name="id_auth_user" />
                                <input id="idWl" type="text" class="visually-hidden" name="id_worklist" />
                                <input id="methodTonoPachySubmit" type="text" class="visually-hidden"
                                    name="methodTonoPachySubmit" value="POST" />
                                <input id="btnTonoPachySubmit" type="submit" class="visually-hidden" />
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <label id="TonoPachySubmit" for="btnTonoPachySubmit" class="btn btn-primary" tabindex="0">Submit</label>
            </div>
        </div>
    </div>
</div>



<div id="wldetails">
    <p>Worklist id: [[= wlId ]]</p>
</div>

[[ block js_scripts]]
<!-- Global variables and utilities first -->
<script type="text/javascript">
    // Global variables - define only once
    window.HOSTURL = "[[ = hosturl ]]";
    window.APP_NAME = "[[ = app_name ]]";
    window.BASE_API = `${HOSTURL}/${APP_NAME}/api`;
    window.wlId = "[[= wlId ]]";

    // Tables configuration
    window.TONO_TABLES_CONFIG = {
        '#airPachyRight_tbl': { laterality: 'right', techno: 'air' },
        '#airPachyLeft_tbl': { laterality: 'left', techno: 'air' },
        '#aplaRight_tbl': { laterality: 'right', techno: 'apla' },
        '#aplaLeft_tbl': { laterality: 'left', techno: 'apla' }
    };

    // API endpoints with params - note the @lookup prefix
    window.TONO_PARAMS = {
        '@lookup': 'mod!:modified_by[id,first_name,last_name],creator!:created_by[id,first_name,last_name]',
        '@count': true,
        '@order': '~id'
    };

    // Bootstrap table common options
    window.BOOTSTRAP_TABLE_OPTIONS = {
        pagination: true,
        pageSize: 10,
        sidePagination: 'server',
        queryParamsType: ''  // Remove ? from URL
    };
</script>

<!-- Load dependencies -->
<script src="js/bootstrap-table_1.22/bootstrap-table.min.js"></script>
<script src="js/bootbox/bootbox.all.min.js"></script>
<script src="js/jquery.serialize-object.min.js"></script>
<script src="js/useful.js"></script>

<!-- Load application specific scripts -->
<script src="js/patient-bar.js"></script>
<script src="js/tono_bt.js"></script>

<!-- Main application logic -->
<script type="text/javascript">
    async function fetchTonoData(laterality, techno) {
        try {
            const params = {
                ...TONO_PARAMS,
                'laterality.eq': laterality,
                'techno.eq': techno,
                'id_worklist.eq': wlId,
                '@limit': 10
            };

            return await makeAPIRequest(`${BASE_API}/tono`, params);
        } catch (error) {
            console.error(`Failed to fetch ${techno} tonometry data for ${laterality} eye:`, error);
            displayToast('error', 'Data fetch failed', `Could not load ${techno} tonometry data for ${laterality} eye. Will retry automatically.`);
            throw error;
        }
    }

    async function refreshTonoTables() {
        try {
            const [airRight, airLeft, aplaRight, aplaLeft] = await Promise.allSettled([
                fetchTonoData('right', 'air'),
                fetchTonoData('left', 'air'),
                fetchTonoData('right', 'apla'),
                fetchTonoData('left', 'apla')
            ]);

            // Handle results, even if some failed
            if (airRight.status === 'fulfilled') {
                $('#airPachyRight_tbl').bootstrapTable('load', airRight.value);
            }
            if (airLeft.status === 'fulfilled') {
                $('#airPachyLeft_tbl').bootstrapTable('load', airLeft.value);
            }
            if (aplaRight.status === 'fulfilled') {
                $('#aplaRight_tbl').bootstrapTable('load', aplaRight.value);
            }
            if (aplaLeft.status === 'fulfilled') {
                $('#aplaLeft_tbl').bootstrapTable('load', aplaLeft.value);
            }
        } catch (error) {
            console.error('Error refreshing tonometry tables:', error);
            displayToast('error', 'Refresh failed', 'Failed to refresh some tonometry data. Will retry automatically.');
        }
    }

    let refreshInterval;
    function startAutoRefresh() {
        stopAutoRefresh();
        refreshInterval = setInterval(refreshTonoTables, 30000);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Initialize when document is ready
    $(document).ready(function () {
        // Initialize bootstrap tables with correct configuration
        Object.entries(TONO_TABLES_CONFIG).forEach(([tableId, config]) => {
            $(tableId).bootstrapTable({
                ...BOOTSTRAP_TABLE_OPTIONS,
                url: `${BASE_API}/tono`,
                queryParams: function (params) {
                    return {
                        ...TONO_PARAMS,
                        '@limit': params.pageSize,
                        '@offset': params.pageSize * (params.pageNumber - 1),
                        'laterality.eq': config.laterality,
                        'techno.eq': config.techno,
                        'id_worklist.eq': wlId
                    };
                }
            });
        });

        refreshTonoTables();
        startAutoRefresh();
    });

    // Clean up on page unload
    $(window).on('unload', function () {
        stopAutoRefresh();
    });
</script>

<!-- Load page specific script last -->
<script src="js/tono.js"></script>
[[ end ]]