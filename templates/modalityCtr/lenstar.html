[[extend "baseof.html"]]

[[ block page_head]]
<link href="js/bootstrap-table_1.22/bootstrap-table.min.css" rel="stylesheet">
<style>
    /* overide when topnavbar is not fixed-top */
    section#main { margin-top: 50px; }
</style>
[[ end ]]

[[ block left_nav ]]
[[ end]]

[[ include 'partials/patient-bar.html' ]]

<div class="container-fluid mb-3"> <!-- controller title-->
    <div class="row big-title bg-neutral">
        <div class="col">
            <h1><a role="button" data-bs-toggle="collapse" href=".md">Medical examination</a></h1>
        </div>
    </div>
</div>

<div class="container-fluid mt-2">
    <div class="row">
        <div class="col-9">
            <canvas id="myChart"></canvas>
        </div>
        <div class="col-3">
            <button id="btnGetFromEyesuite" class="btn btn-primary btn-sm" type="button">GET</button>
        </div>
    </div>
</div>


[[ block js_scripts]]
<script type="text/javascript">
// Global variables
const HOSTURL = "[[ = hosturl ]]";
const btnArr = [];


let url = HOSTURL + "/myapp/rest/lenstar?lastname="+patientObj['last_name']+"&firstname="+patientObj['first_name'].replace(' ','_');

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="js/bootstrap-table_1.22/bootstrap-table.min.js"></script>
<script src="js/bootbox/bootbox.all.min.js"></script>
<script src="js/jquery.serialize-object.min.js"></script>
<script src="js/useful.js"></script>
<script src="js/patient-bar.js"></script>
<script src="js/lenstar.js"></script>

<script type="text/javascript">

let dob;

patientObj['dob'] != null ? dob = patientObj['dob'] : dob= '';

const normativeData = [
    {
        "label": "Percentile 3",
        "data": [
            {"x": 4, "y": 21.26},
            {"x": 5, "y": 21.49},
            {"x": 6, "y": 21.71},
            {"x": 7, "y": 21.91},
            {"x": 8, "y": 22.09},
            {"x": 9, "y": 22.27},
            {"x": 10, "y": 22.42},
            {"x": 11, "y": 22.56},
            {"x": 12, "y": 22.68},
            {"x": 13, "y": 22.78},
            {"x": 14, "y": 22.86},
            {"x": 15, "y": 22.91},
            {"x": 16, "y": 22.94},
            {"x": 17, "y": 22.95},
            {"x": 18, "y": 22.92}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 5",
        "data": [
            {"x": 4, "y": 21.41},
            {"x": 5, "y": 21.64},
            {"x": 6, "y": 21.86},
            {"x": 7, "y": 22.07},
            {"x": 8, "y": 22.26},
            {"x": 9, "y": 22.44},
            {"x": 10, "y": 22.6},
            {"x": 11, "y": 22.75},
            {"x": 12, "y": 22.88},
            {"x": 13, "y": 22.99},
            {"x": 14, "y": 23.08},
            {"x": 15, "y": 23.15},
            {"x": 16, "y": 23.2},
            {"x": 17, "y": 23.23},
            {"x": 18, "y": 23.22}
        ],
        "fill": false,
        "borderColor": "rgb(31, 0, 224)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 10",
        "data": [
            {"x": 4, "y": 21.63},
            {"x": 5, "y": 21.87},
            {"x": 6, "y": 22.1},
            {"x": 7, "y": 22.32},
            {"x": 8, "y": 22.53},
            {"x": 9, "y": 22.72},
            {"x": 10, "y": 22.89},
            {"x": 11, "y": 23.05},
            {"x": 12, "y": 23.2},
            {"x": 13, "y": 23.33},
            {"x": 14, "y": 23.44},
            {"x": 15, "y": 23.53},
            {"x": 16, "y": 23.6},
            {"x": 17, "y": 23.66},
            {"x": 18, "y": 23.69}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 25",
        "data": [
            {"x": 4, "y": 21.99},
            {"x": 5, "y": 22.26},
            {"x": 6, "y": 22.51},
            {"x": 7, "y": 22.75},
            {"x": 8, "y": 22.98},
            {"x": 9, "y": 23.19},
            {"x": 10, "y": 23.4},
            {"x": 11, "y": 23.58},
            {"x": 12, "y": 23.76},
            {"x": 13, "y": 23.92},
            {"x": 14, "y": 24.06},
            {"x": 15, "y": 24.19},
            {"x": 16, "y": 24.31},
            {"x": 17, "y": 24.41},
            {"x": 18, "y": 24.5}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 50",
        "data": [
            {"x": 4, "y": 22.39},
            {"x": 5, "y": 22.69},
            {"x": 6, "y": 22.97},
            {"x": 7, "y": 23.25},
            {"x": 8, "y": 23.51},
            {"x": 9, "y": 23.76},
            {"x": 10, "y": 23.99},
            {"x": 11, "y": 24.22},
            {"x": 12, "y": 24.43},
            {"x": 13, "y": 24.62},
            {"x": 14, "y": 24.81},
            {"x": 15, "y": 24.98},
            {"x": 16, "y": 25.13},
            {"x": 17, "y": 25.28},
            {"x": 18, "y": 25.41}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 75",
        "data": [
            {"x": 4, "y": 22.78},
            {"x": 5, "y": 23.12},
            {"x": 6, "y": 23.45},
            {"x": 7, "y": 23.76},
            {"x": 8, "y": 24.07},
            {"x": 9, "y": 24.36},
            {"x": 10, "y": 24.64},
            {"x": 11, "y": 24.9},
            {"x": 12, "y": 25.15},
            {"x": 13, "y": 25.39},
            {"x": 14, "y": 25.61},
            {"x": 15, "y": 25.82},
            {"x": 16, "y": 26.01},
            {"x": 17, "y": 26.18},
            {"x": 18, "y": 26.35}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 90",
        "data": [
            {"x": 4, "y": 23.13},
            {"x": 5, "y": 23.51},
            {"x": 6, "y": 23.88},
            {"x": 7, "y": 24.24},
            {"x": 8, "y": 24.6},
            {"x": 9, "y": 24.93},
            {"x": 10, "y": 25.26},
            {"x": 11, "y": 25.57},
            {"x": 12, "y": 25.86},
            {"x": 13, "y": 26.14},
            {"x": 14, "y": 26.39},
            {"x": 15, "y": 26.63},
            {"x": 16, "y": 26.84},
            {"x": 17, "y": 27.04},
            {"x": 18, "y": 27.21}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    },
    {
        "label": "Percentile 95",
        "data": [
            {"x": 4, "y": 23.33},
            {"x": 5, "y": 23.74},
            {"x": 6, "y": 24.15},
            {"x": 7, "y": 24.54},
            {"x": 8, "y": 24.92},
            {"x": 9, "y": 25.3},
            {"x": 10, "y": 25.65},
            {"x": 11, "y": 25.99},
            {"x": 12, "y": 26.31},
            {"x": 13, "y": 26.61},
            {"x": 14, "y": 26.89},
            {"x": 15, "y": 27.14},
            {"x": 16, "y": 27.36},
            {"x": 17, "y": 27.56},
            {"x": 18, "y": 27.74}
        ],
        "fill": false,
        "borderColor": "rgb(0, 0, 0)",
        "borderDash": [5, 5]
    }];

let datasets = normativeData;

console.log("datasets",datasets);

var blueShades = [
    'rgb(0, 0, 255)', // Strong blue
    'rgb(70, 130, 180)', // Lighter blue
    'rgb(135, 206, 235)', // Even lighter blue
    'rgb(240, 248, 255)', // Lightest blue
];

var redShades = [
    'rgb(255, 99, 71)', // Light red
    'rgb(255, 0, 0)', // Strong red
    'rgb(139, 0, 0)', // Even stronger red
];

// Set the colors for percentiles 3 to 25
for (var i = 0; i < 4; i++) {
    datasets[i].borderColor = blueShades[i];
}

// Set the color for percentile 50
datasets[4].borderColor = 'rgb(0, 0, 0)'; // Black
datasets[4].borderDash = []; // Solid line

// Set the colors for percentiles 75 to 95
for (var i = 0; i < 3; i++) {
    datasets[i + 5].borderColor = redShades[i];
}


fetch(url)
    .then(response => response.json())
    .then(data => {
        let ages_od = [];
        let axial_lengths_od = [];
        console.log("response",data);
        dob = new Date(dob);
        for(filePath in data.data.exams) {
            console.log('in filepath',filePath);
            let eyes = data.data['exams'][filePath];
            console.log('eyes',eyes);
            for (let eye in eyes) {
                console.log("eye:",eyes[eye]['EXAMINATION']['DATE']);
                console.log("date",eyes[eye]);
                let examDate = new Date(eyes[eye]['EXAMINATION']['DATE'].replace(/(\d{4})\.(\d{2})\.(\d{2})/, "$1-$2-$3"));
                console.log(eyes[eye]['EXAMINATION']['DATE'].replace(/(\d{4})\.(\d{2})\.(\d{2})/, "$1-$2-$3"));
                let ageInMilliseconds = examDate - dob;
                let ageInYears = ageInMilliseconds / (1000 * 60 * 60 * 24 * 365.25);  // Convert from milliseconds to years
                ages.push(ageInYears.toFixed(2));
                axial_lengths.push(eyes[eye]['A-SCAN']['AXIAL_LENGTH']);
            };
        }
        console.log("ages",ages);
        let combined = ages.map((age, index) => {
            return { x: parseFloat(age), y: axial_lengths[index] };
        });
        console.log("combined",combined);
        datasets.push({
                    label: 'Axial Length',
                    data: combined,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(0,0,0,0)'
                });

        console.log("datasets",datasets);

        let ctx = document.getElementById('myChart').getContext('2d');
        let myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Age (years)'
                        }
                    },
                    y: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Axial Length (mm)'
                        }
                    }
                }
            }
        });
    })
    .catch(error => console.error('Error:', error));

</script>