[[extend 'baseof.html']]

[[ block left_nav ]]
[[ end]]

<div class="container-fluid py-1 patient-id" id="patientTitle">
    <div class="row mb-3 d-flex justify-content-center align-items-center">
        <div id="patientIdDiv" class="col-4 text-end">
            <h3 class="wlID">01/01/2024 - Worklist #1545</h3>
            <h3 class="patientName"></h3>
            <h5 class="patientDob text-muted"></h5>
            <h5 class="patientGender fst-italic"></h5>
        </div>
        <div class="col-2 photoDiv visually-hidden text-center">
            <img class="photoId" src="" alt="Photo from EID">
        </div>
        <div class="col-4 text-start">
            <h5 class="patientId fst-italic"></h5>
            <h5 class="patientSsn fst-italic"></h5>
            <h6 class="patientCard fst-italic"></h6>
            <h6 class="patientEmail fst-italic"></h6>
        </div>
    </div>
</div>

<div class="container-fluid d-none">
    <div class="row">
        <div class="col">
            <h2>Full History</h2>
            <table class="table table-striped" id="combinedRecordsTable">
                <thead>
                    <tr>
                        <!-- Headers will be added dynamically here -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Data rows will be added dynamically here -->
                </tbody>
            </table>    
        </div>
    </div>
</div>

<div class="container-fluid py-2">
    <div class="row">
        <div class="col">
            <h2>Codes</h2>
            <table class="table table-striped">
                <tr>
                    <th>Date</th>
                    <th>Code</th>
                    <th>Cost</th>
                    <th>INAMI</th>
                </tr>
                <tr>
                    <th>01/01/2024</th>
                    <td>105755</td>
                    <td>30</td>
                    <th>yes</th>
                </tr>
                <tr>
                    <th>01/01/2024</th>
                    <td>249233</td>
                    <td>7</td>
                    <td>yes</td>
                </tr>
                <tr>
                    <th>01/01/2024</th>
                    <td>IPL</td>
                    <td>70</td>
                    <td>no</td>
                </tr>
            </table>
        </div>
        <div class="col">
            <h2>Breakdown</h2>
            <table class="table table-striped">
                <tr>
                    <th>Date</th>
                    <td>01/01/2024</td>
                    <td>Action</td>
                </tr>
                <tr>
                    <th>INAMI</th>
                    <td>30</td>
                    <td><button type="button" class="btn btn-primary" style="--bs-btn-padding-y: .20rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .65rem;">Print Attestation</button></td>
                </tr>
                <tr>
                    <th>Supplements</th>
                    <td>47</td>
                    <td></td>
                </tr>
                <tr>
                    <th>Not covered</th>
                    <td>70</td>
                    <td><button type="button" class="btn btn-secondary" style="--bs-btn-padding-y: .20rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .65rem;">Print bill</button></td>
                </tr>    
            </table>
        </div>
    </div>
</div>

<div class="container-fluid my-2">
    <div class="row">
        <div class="col">
            <h2>Transactions</h2>
            <table class="table table-striped">
                <tr>
                    <th>Date</th>
                    <th>Price</th>
                    <th>Paid</th>
                    <th>Card</th>
                    <th>Cash</th>
                    <th>Invoice</th>
                </tr>
                <tr>
                    <th>01/01/2024</th>
                    <td>147.00‚Ç¨</td>
                    <td>140.00‚Ç¨</td>
                    <td>0.00‚Ç¨</td>
                    <td>0.00‚Ç¨</td>
                    <td>0.00‚Ç¨</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col">
            <h2>Remaining to pay:</h2>
            <button type="button" id="btnNewpayment" class="btn btn btn-danger" data-bs-toggle="modal" data-bs-target="#paymentModal">Pay 147 ‚Ç¨</button>
        </div>
    </div>
</div>

<!-- Modal paymentModal -->
<div class="modal fade mt-5" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Encode payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <form id="paymentFormModal">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-4">
                                    <span for="cardPayment" class="form-label">üí≥ Card:</span>
                                    <div class="input-group">
                                        <span class="input-group-text">‚Ç¨</span>
                                        <input id="cardPayment" type="number" class="form-control text-end" name="card_payment" min="0" step="0.01" value="0" aria-label="Amount (to the nearest euro)">
                                        <span class="input-group-text">.00</span>
                                    </div> 
                                </div>
                                <div class="col-4">
                                    <span for="cashPayment" class="form-label">üíµ Cash:</span>
                                    <div class="input-group">
                                        <span class="input-group-text">‚Ç¨</span>
                                        <input id="cashPayment" type="number" class="form-control text-end" name="cash_payment" min="0" step="0.01" value="0" aria-label="Amount (to the nearest euro)">
                                        <span class="input-group-text">.00</span>
                                    </div> 
                                </div>
                                <div class="col-4">
                                    <span for="invoicePayment" class="form-label">üè¶ Invoice:</span>
                                    <div class="input-group">
                                        <span class="input-group-text">‚Ç¨</span>
                                        <input id="invoicePayment" type="number" class="form-control text-end" name="invoice_payment" min="0" step="0.01" value="0" aria-label="Amount (to the nearest euro)">
                                        <span class="input-group-text">.00</span>
                                    </div> 
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-4">
                                    <select id="cardType" class="form-select" name="card_type" aria-label="Select card type">
                                        <option value="bc" selected>Bancontact</option>
                                        <option value="contactless">Contactless</option>
                                        <option value="visa">Visa</option>
                                        <option value="mc">Mastercard</option>
                                    </select>
                                </div>
                                <div class="col-4"></div>
                                <div class="col-4">
                                    <select id="invoiceType" class="form-select" name="invoice_type" aria-label="Select invoice type">
                                        <option value="council" selected>Council</option>
                                        <option value="transfer">Bank transfer</option>
                                        <option value="visa">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="text-center">
                                        <span class="fs-3 py-2">Amount to pay: <span id="remainPayment">147</span> ‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="recordPayment" class="btn btn-danger" data-bs-dismiss="modal" data-cert-flag="pay">Record Payment (sum)</button>
            </div>
        </div>
    </div>
</div>




[[ block js_scripts ]]
<script type="text/javascript">
// globals
const id = [[ =rec_id ]]
const membership = [[=membership]];
const HOSTURL = "[[ = hosturl ]]";

const API_USER= HOSTURL+'[[=URL('api','auth_user')]]'+'?id.eq='+id+'&@lookup=gender,marital,membership,ethny&@count=true'; 
const API_CHXUSER = HOSTURL + '[[=URL('api','current_hx')]]' + '?@count=true&@lookup=mod!:modified_by[id,first_name,last_name],creator!:created_by[id,first_name,last_name]&id_auth_user.eq=' + id
const API_CCXUSER = HOSTURL + '[[=URL('api','ccx')]]' + '?@count=true&@lookup=mod!:modified_by[id,first_name,last_name],creator!:created_by[id,first_name,last_name]&id_auth_user.eq=' + id
const API_FOLUSER = HOSTURL + '[[=URL('api','followup')]]' + '?@count=true&@lookup=mod!:modified_by[id,first_name,last_name],creator!:created_by[id,first_name,last_name]&id_auth_user.eq=' + id
const API_BILUSER = HOSTURL + '[[=URL('api','billing')]]' + '?@count=true&@lookup=mod!:modified_by[id,first_name,last_name],creator!:created_by[id,first_name,last_name]&id_auth_user.eq=' + id

</script>
<script src="js/bootstrap-table_1.22/bootstrap-table.min.js"></script>
<script src="js/payments-bt.js"></script>
<script src="js/bootbox/bootbox.all.min.js"></script>
<script src="js/useful.js"></script>

<script type="text/javascript">

{{/*  var $chx = $('#chx_tbl').bootstrapTable({
    url: API_CHXUSER
});

var $ccx = $('#ccx_tbl').bootstrapTable({
    url: API_CCXUSER
});

var $fol = $('#fol_tbl').bootstrapTable({
    url: API_FOLUSER
});

var $bil = $('#bil_tbl').bootstrapTable({
    url: API_BILUSER
});  */}}
    

const endpoints = [
        { 'name': 'History', 'api': API_CHXUSER },
        { 'name': 'Conclusion', 'api': API_CCXUSER },
        { 'name': 'Follow-up', 'api': API_FOLUSER },
        { 'name': 'Billing', 'api': API_BILUSER }
        // ... add more endpoints as needed
    ];


document.addEventListener('DOMContentLoaded', function() {
    
    const combinedTable = document.getElementById('combinedRecordsTable');
    const combinedTableHead = combinedTable.querySelector('thead tr');
    const combinedTableBody = combinedTable.querySelector('tbody');

    // Dynamically create headers
    endpoints.forEach(endpoint => {
        combinedTableHead.innerHTML += `<th scope="col">Timestamp</th>`;
        combinedTableHead.innerHTML += `<th scope="col">${endpoint.name}</th>`;
    });

    // Create a promise for each API endpoint
    const promises = endpoints.map(endpoint => 
        fetch(endpoint.api).then(response => response.json())
    );

    Promise.all(promises)
        .then(allData => {
            // Initialize an array for combined rows
            let combinedRows = [];

            // Combine data from all endpoints, aligning by index
            const maxLength = Math.max(...allData.map(data => data.items.length));
            for (let i = 0; i < maxLength; i++) {
                combinedRows[i] = allData.map(data => data.items[i] || {});
            }

            // Sort combined rows by the first timestamp in descending order
            combinedRows.sort((a, b) => {
                const dateA = new Date(a[0].created_on);
                const dateB = new Date(b[0].created_on);
                return dateB - dateA;
            });

            // Populate the table rows
            combinedRows.forEach(rowItems => {
                const row = document.createElement('tr');
                rowItems.forEach((item, index) => {
                    const isFirstColumn = index === 0;
                    const isLastColumn = index === rowItems.length - 1;
                    row.innerHTML += `
                        <td class="${isFirstColumn ? 'fw-bold' : ''}">${item.created_on || ''}</td>
                        <td class="${isLastColumn ? 'fw-bold' : ''}">${item.description || ''}</td>
                    `;
                });
                combinedTableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error:', error));
});
    
</script>
<script src="js/payments.js"></script>
[[ end ]]